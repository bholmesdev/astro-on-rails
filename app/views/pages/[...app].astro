---
const rubyResponse = await fetch(
  new URL(Astro.url.pathname, "http://localhost:3000")
);

if (!rubyResponse.ok) {
  return rubyResponse;
}
const view = rubyResponse.headers.get("X-Astro-View");
if (!view) {
  return rubyResponse;
}
let props = {};
const contentType = rubyResponse.headers.get("Content-Type");
const baseType = contentType?.split(";")?.[0]?.toLowerCase();
if (baseType === "application/json") {
  props = await rubyResponse.json();
}

const rewriteUrl = new URL(
  "/views/" + view.replace("index", ""),
  Astro.url.origin
);
Astro.locals.rubyProps = props;
return Astro.rewrite(rewriteUrl);
---
